(function() {
    'use strict';
 
    const i18n = {
        'zh': {
            downloadText: 'Free Download',
            error: {
                addNormalButton: '添加普通下载按钮时出错:',
                addShortsButton: '添加Shorts下载按钮时出错:'
            }
        },
        'en': {
            downloadText: 'Free Download',
            error: {
                addNormalButton: 'Error adding normal download button:',
                addShortsButton: 'Error adding Shorts download button:'
            }
        },
        'ja': {
            downloadText: '無料ダウンロード',
            error: {
                addNormalButton: '通常ダウンロードボタンの追加エラー:',
                addShortsButton: 'Shortsダウンロードボタンの追加エラー:'
            }
        },
        'es': {
            downloadText: 'Descarga Gratis',
            error: {
                addNormalButton: 'Error al agregar botón de descarga normal:',
                addShortsButton: 'Error al agregar botón de descarga Shorts:'
            }
        },
        'pt': {
            downloadText: 'Download Grátis',
            error: {
                addNormalButton: 'Erro ao adicionar botão de download normal:',
                addShortsButton: 'Erro ao adicionar botão de download Shorts:'
            }
        }
    };
 
    GM_addStyle(`
        .youhou-download-btn {
            background: rgb(242, 242, 242);
            border: none;
            border-radius: 18px;
            color: #0f0f0f;
            padding: 0 16px;
            height: 36px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }
        .youhou-download-btn:hover {
            background: rgb(230, 230, 230);
        }
        .youhou-buttons-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    `);
 
    function waitForElement(selector, callback, maxTries = 10) {
        let tries = 0;
        
        function check() {
            const element = document.querySelector(selector);
            if (element) {
                callback(element);
                return;
            }
            
            tries++;
            if (tries < maxTries) {
                setTimeout(check, 1000);
            }
        }
        
        check();
    }
 
    function createDownloadButton() {
        if (document.querySelector('.youhou-download-btn')) {
            return;
        }
        
        const downloadButton = document.createElement('button');
        downloadButton.className = 'youhou-download-btn';
        downloadButton.textContent = i18n['zh'].downloadText;
        
        downloadButton.addEventListener('click', function() {
            const videoUrl = window.location.href;
            const downloadDomains = ['addyoutube.com'];
            const randomDomain = downloadDomains[Math.floor(Math.random() * downloadDomains.length)];
            const newUrl = videoUrl.replace('youtube.com', randomDomain);
            window.open(newUrl, '_blank');
        });
        
        return downloadButton;
    }
 
    function tryAddButton() {
        waitForElement('#subscribe-button button', (subscribeButton) => {
            if (!document.querySelector('.youhou-download-btn')) {
                const downloadButton = createDownloadButton();
                const container = subscribeButton.closest('#subscribe-button');
                if (container) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'youhou-buttons-wrapper';
                    
                    container.parentNode.insertBefore(wrapper, container);
                    wrapper.appendChild(container);
                    
                    wrapper.appendChild(downloadButton);
                }
            }
        });
    }
 
    document.addEventListener('yt-navigate-finish', function() {
        if (window.location.pathname.includes('/watch')) {
            setTimeout(tryAddButton, 1000);
        }
    });
 
    if (window.location.pathname.includes('/watch')) {
        setTimeout(tryAddButton, 1000);
    }
 
})();
